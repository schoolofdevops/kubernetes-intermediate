---
phase: 04-advanced-content
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/section-5/01-overview.mdx
  - docs/section-5/02-reading.md
  - docs/section-5/03-lab.md
  - docs/section-5/quiz.md
autonomous: true

must_haves:
  truths:
    - "Learner can read Module 5 content in 10-20 minutes and understand NetworkPolicy, Pod Security Admission, RBAC, and Secrets management"
    - "Learner can follow the lab to secure the Voting App incrementally: default deny, selective allow, PSA enforcement, RBAC, and Secrets"
    - "Learner can answer 12-15 quiz questions about Kubernetes security concepts and best practices"
    - "Module 5 creates a NEW KIND cluster with Calico CNI (required for NetworkPolicy enforcement)"
  artifacts:
    - path: "docs/section-5/02-reading.md"
      provides: "Security concepts reading with NetworkPolicy, PSA, RBAC, Secrets management"
      min_lines: 200
    - path: "docs/section-5/03-lab.md"
      provides: "Hands-on security lab with 4 tasks securing the Voting App"
      min_lines: 300
    - path: "docs/section-5/quiz.md"
      provides: "12-15 security quiz questions"
      min_lines: 120
  key_links:
    - from: "docs/section-5/03-lab.md"
      to: "Calico CNI"
      via: "Lab setup creates KIND cluster with disableDefaultCNI and installs Calico"
      pattern: "disableDefaultCNI"
    - from: "docs/section-5/02-reading.md"
      to: "docs/section-5/03-lab.md"
      via: "Next Steps info box linking to lab"
      pattern: "lab"
---

<objective>
Create complete Module 5: Security (NetworkPolicy, PSA, RBAC) - teaching learners to secure the Voting App incrementally using defense-in-depth principles. This is the first module in Phase 4, marking the transition from "make the app work well" (Modules 0-4) to "make the app production-ready" (Modules 5-9).

Purpose: Security is the most critical production concern. Learners move from "everything can talk to everything" to explicit, least-privilege communication. This module requires a new KIND cluster with Calico CNI since NetworkPolicy enforcement requires a CNI that supports it (Flannel/default KIND CNI does not).

Output: Complete Module 5 (overview, reading, lab, quiz) with 3-4 Mermaid diagrams and a comprehensive lab covering NetworkPolicy, PSA, RBAC, and Secrets.
</objective>

<execution_context>
@/Users/gshah/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gshah/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-advanced-content/04-RESEARCH.md
@templates/content-template.md
@templates/lab-template.md
@templates/quiz-template.md
@templates/AUTHORING-GUIDE.md
@docs/section-5/01-overview.mdx
@docs/section-1/02-reading.md
@docs/section-1/03-lab.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Module 5 reading materials with overview update and Mermaid diagrams</name>
  <files>
    docs/section-5/01-overview.mdx
    docs/section-5/02-reading.md
  </files>
  <action>
**1. Update docs/section-5/01-overview.mdx:**
Replace the current placeholder content. Create proper module landing page:
- Title: "Module 5: Security (NetworkPolicy, PSA, RBAC)"
- Frontmatter: sidebar_position: 1, title: "Overview"
- Metadata block: Difficulty: Intermediate, Estimated Time: 100 minutes (20 min reading + 60 min lab + 15 min quiz)
- "What You Will Learn" (5 items): NetworkPolicy for pod-to-pod communication control, Pod Security Admission for enforcing security baselines, RBAC and ServiceAccounts for least-privilege access, Secrets management (moving credentials out of env vars), defense-in-depth security strategy for Kubernetes applications
- "Prerequisites": KIND and kubectl installed, familiarity with Voting App architecture from Modules 0-4. This module creates a FRESH cluster with Calico CNI.
- Brief 2-paragraph overview: "Your Voting App works, scales, and routes traffic. But right now, any pod can talk to any other pod. The worker service has the same permissions as a cluster admin. Database passwords are in plain environment variables. In production, this is a security incident waiting to happen. This module locks down the Voting App layer by layer."

**2. Create docs/section-5/02-reading.md:**
Follow templates/content-template.md. Target: 15-20 minute read (~3000-4000 words). Conversational tone, no emojis.

Content structure:
- **Overview** (2-3 paragraphs): The security problem - your app is wide open. Any pod can reach any pod (vote can talk to postgres directly). Default service accounts have excessive permissions. Secrets are in environment variables visible via kubectl describe. Frame as defense-in-depth: multiple layers, each providing protection.
- **NetworkPolicy: Controlling Pod Communication** section:
  - Default Kubernetes behavior: no network restrictions (flat network, everything talks to everything)
  - CRITICAL prerequisite: NetworkPolicy requires a CNI that supports it (Calico, Cilium). Flannel (KIND default) ignores policies silently - this is the number 1 gotcha.
  - Default deny pattern: start by blocking everything, then allow explicitly
  - DNS allowlist: MUST allow egress to kube-dns (port 53 UDP) or service discovery breaks
  - Include Mermaid diagram: Voting App network flow showing before (all arrows) vs after (only allowed arrows: vote->redis, worker->redis, worker->postgres, result->postgres)
  - YAML examples: default-deny-all policy, allow-dns policy, vote-to-redis policy (from research Example 1)
  - Tip admonition: "Always test NetworkPolicies in a non-production namespace first. A bad deny-all policy can make your entire application unreachable."
- **Pod Security Admission (PSA)** section:
  - What replaced PodSecurityPolicies (removed in K8s 1.25)
  - Three security profiles: privileged (no restrictions), baseline (prevents known privilege escalations), restricted (hardened, minimal permissions)
  - Three enforcement modes: enforce (block), audit (log), warn (show warning)
  - Applied via namespace labels (not pod-level)
  - CRITICAL: PSA evaluates at pod CREATE time only. Existing pods are grandfathered. Must rollout restart after applying labels.
  - Include Mermaid diagram: PSS profile hierarchy (privileged -> baseline -> restricted) showing what each blocks
  - YAML example: namespace with PSA labels (from research Example 2)
  - Testing PSA: try creating a privileged pod, see it rejected
- **RBAC for Application Teams** section:
  - ServiceAccounts: pods use default SA which may have excessive permissions
  - Role vs ClusterRole: namespace-scoped vs cluster-wide
  - RoleBinding vs ClusterRoleBinding
  - Least-privilege principle: start with nothing, add only what is needed
  - Include Mermaid diagram: RBAC relationship diagram (ServiceAccount -> RoleBinding -> Role -> specific permissions on resources)
  - YAML example: minimal Role for vote service (only get/list/watch configmaps)
  - Anti-pattern: binding to cluster-admin "to make it work" (from research Pitfall 6)
  - Practical command: `kubectl auth can-i --list --as=system:serviceaccount:voting-app:vote-sa`
- **Secrets Management** section:
  - Problem: credentials in plain env vars (visible with kubectl describe pod)
  - Solution: Kubernetes Secret resources with volume mounts
  - Base64 encoding is NOT encryption (common misconception)
  - Best practice: mount secrets as files, not environment variables (files can have restrictive permissions, auto-update on Secret changes)
  - Brief mention: for production, consider Sealed Secrets or External Secrets Operator (don't hand-roll encryption)
- **Defense in Depth** section:
  - Layer 1: NetworkPolicy (network-level isolation)
  - Layer 2: PSA (prevent privilege escalation at pod level)
  - Layer 3: RBAC (API-level access control)
  - Layer 4: Secrets (credential protection)
  - No single layer is sufficient alone. Each protects against different attack vectors.
- **Summary** with 5 bullet points
- **Further Reading** with links to K8s security docs, NetworkPolicy recipes repo
- Info admonition: "Next Steps - Secure the Voting App layer by layer in the lab"
  </action>
  <verify>
    - Both files exist and are non-empty
    - `npm run build` succeeds
    - 02-reading.md contains at least 3 Mermaid diagram code blocks (network flow, PSS hierarchy, RBAC relationship)
    - 02-reading.md word count is 3000-4000 words
    - Content mentions Calico CNI requirement for NetworkPolicy
    - Content explains PSA replaces PodSecurityPolicies
    - Content warns about DNS allowlist requirement
    - No emojis, all code blocks have language tags
  </verify>
  <done>Module 5 reading materials explain security concepts (NetworkPolicy, PSA, RBAC, Secrets) with 3-4 Mermaid diagrams, YAML examples, and practical gotchas targeting 15-20 min read time.</done>
</task>

<task type="auto">
  <name>Task 2: Create Module 5 lab and quiz</name>
  <files>
    docs/section-5/03-lab.md
    docs/section-5/quiz.md
  </files>
  <action>
**1. Create docs/section-5/03-lab.md:**
Follow templates/lab-template.md 8-section structure. Duration: 50-60 minutes. This lab creates a FRESH KIND cluster with Calico CNI.

Title: "Lab: Securing the Voting App"

- **Objectives** (5 items): Create a KIND cluster with Calico CNI for NetworkPolicy support, implement default-deny NetworkPolicy and selective allow rules, apply Pod Security Admission to enforce baseline security, create least-privilege ServiceAccounts and RBAC roles, move credentials from environment variables to Kubernetes Secrets
- **Prerequisites**: KIND and kubectl installed, Voting App YAML files from Module 0 (examples/ directory)
- **Setup**:
  - Delete any existing KIND cluster: `kind delete cluster --name voting-app` (if exists)
  - Create NEW KIND cluster with Calico CNI (research shows this requires disableDefaultCNI: true):
    ```yaml
    kind: Cluster
    apiVersion: kind.x-k8s.io/v1alpha4
    networking:
      disableDefaultCNI: true
      podSubnet: 192.168.0.0/16
    nodes:
    - role: control-plane
    - role: worker
    - role: worker
    ```
  - Install Calico: `kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.28.0/manifests/calico.yaml`
  - Wait for Calico ready: `kubectl wait --for=condition=ready --timeout=300s pod -l k8s-app=calico-node -n kube-system`
  - Create voting-app namespace and deploy base Voting App
  - Verify all pods running and app is functional (port-forward test)
  - Explain: "We need Calico because KIND's default Flannel CNI silently ignores NetworkPolicies. With Calico, policies actually enforce."

- **Tasks** (4 tasks + 1 challenge):
  - **Task 1: Network Isolation with NetworkPolicy**:
    Step 1: Apply default-deny-all policy (from research Example 1 - deny all ingress AND egress in voting-app namespace). Show YAML with podSelector: {} selecting all pods.
    Step 2: Verify traffic is blocked. Port-forward to vote service - it should fail or timeout when trying to submit a vote (can't reach redis). Show expected error.
    Step 3: Allow DNS (CRITICAL - without this, services can't resolve each other). Apply egress rule allowing UDP port 53 to kube-system namespace.
    Step 4: Allow vote->redis (ingress to redis from vote pods on port 6379, egress from vote to redis on 6379).
    Step 5: Allow worker->redis AND worker->postgres (worker needs both).
    Step 6: Allow result->postgres (result reads from postgres on port 5432).
    Step 7: Allow external ingress to vote (port 80) and result (port 80) services.
    Step 8: Verify complete flow: port-forward vote, cast vote, port-forward result, see result. Everything works with minimal allowed paths.
    Include verification commands showing NetworkPolicy is enforced: try to exec into vote pod and ping postgres directly (should fail).

  - **Task 2: Pod Security Standards with PSA**:
    Step 1: Apply PSA labels to voting-app namespace: enforce=baseline, audit=restricted, warn=restricted.
    Step 2: Restart all deployments to trigger PSA evaluation: `kubectl rollout restart deployment --all -n voting-app`
    Step 3: Wait for pods to come back up. If any pods fail due to PSA violations, review warnings and fix security contexts.
    Step 4: Test enforcement: try to create a privileged pod in the namespace (should be rejected with clear error message). Show the error.
    Step 5: Try creating a pod with hostNetwork: true (baseline blocks this too). Show rejection.
    Step 6: Check audit logs for restricted policy warnings: existing pods may show warnings about not meeting restricted profile (that is expected - baseline is sufficient for now).

  - **Task 3: Service Accounts and RBAC**:
    Step 1: Create dedicated ServiceAccounts: vote-sa, result-sa, worker-sa.
    Step 2: Create minimal Role for vote service: only get/list/watch on configmaps in voting-app namespace (vote needs to read config, nothing else).
    Step 3: Create RoleBinding: bind vote-sa to vote-role.
    Step 4: Update vote Deployment to use vote-sa ServiceAccount.
    Step 5: Verify permissions: `kubectl auth can-i get configmaps --as=system:serviceaccount:voting-app:vote-sa -n voting-app` (should be yes)
    Step 6: Verify least-privilege: `kubectl auth can-i delete pods --as=system:serviceaccount:voting-app:vote-sa -n voting-app` (should be no)
    Step 7: Repeat minimal roles for result-sa and worker-sa (different permissions based on what each service needs).

  - **Task 4: Secrets Management**:
    Step 1: Create Kubernetes Secret for postgres credentials: `kubectl create secret generic postgres-credentials --from-literal=POSTGRES_USER=postgres --from-literal=POSTGRES_PASSWORD=postgres -n voting-app`
    Step 2: Create Secret for redis credentials (even if no password, demonstrates the pattern): `kubectl create secret generic redis-credentials --from-literal=REDIS_HOST=redis -n voting-app`
    Step 3: Update postgres Deployment to use Secret volume mount instead of env vars. Mount at /etc/secrets/postgres.
    Step 4: Update worker Deployment to reference postgres Secret for database connection.
    Step 5: Verify secrets are mounted correctly: `kubectl exec deploy/db -- ls /etc/secrets/postgres`
    Step 6: Demonstrate that secrets are NOT visible in `kubectl describe pod` when mounted as volumes (compared to env vars which are visible).
    Note: Base64 is encoding not encryption. For production, mention Sealed Secrets.

  - **Challenge: Security Audit**:
    Run a security audit of the secured Voting App:
    - List all NetworkPolicies: `kubectl get networkpolicy -n voting-app`
    - Check PSA enforcement: `kubectl get ns voting-app --show-labels`
    - Audit RBAC: `kubectl auth can-i --list --as=system:serviceaccount:voting-app:vote-sa -n voting-app`
    - Try to break out: exec into vote pod, try to reach an unauthorized service, try to escalate privileges
    - Document findings: what is protected, what gaps remain?

- **Verification**:
  1. NetworkPolicies block unauthorized traffic (vote cannot reach postgres directly)
  2. PSA rejects privileged pod creation in voting-app namespace
  3. ServiceAccounts have minimal permissions verified with `kubectl auth can-i`
  4. Secrets mounted as volumes (not visible in pod describe)
  5. Voting App is fully functional (vote -> see result) despite all security controls

- **Cleanup**: Do NOT destroy the cluster. Keep security controls in place. Module 6 will work with the secured Voting App (or deploy fresh if needed). Note: "This cluster uses Calico CNI. If you need to recreate later, use the same KIND config with disableDefaultCNI: true."

- **Troubleshooting**:
  1. Calico pods not starting (check podSubnet matches 192.168.0.0/16 in KIND config)
  2. All pods lose connectivity after default-deny (forgot DNS allow rule - most common mistake)
  3. PSA blocks existing pods on restart (review security contexts, fix containers running as root)
  4. RBAC denies expected operations (check verb list, resource name, namespace scope)

- **Key Takeaways**: 5 points emphasizing defense-in-depth layering

**2. Create docs/section-5/quiz.md:**
Follow templates/quiz-template.md. Create 14 questions (8 MCQ, 4 scenario, 2 true/false).

Topics:
- NetworkPolicy default behavior (no restrictions without policy)
- Why Flannel doesn't enforce NetworkPolicy (CNI requirement)
- Default deny pattern (scenario: which policy blocks all traffic?)
- DNS allowlist requirement (scenario: app breaks after deny-all, why?)
- PSA profiles: privileged, baseline, restricted differences
- PSA enforcement timing (only at pod creation, not retroactive)
- PodSecurityPolicy vs Pod Security Admission (what replaced what)
- RBAC: Role vs ClusterRole distinction
- ServiceAccount least-privilege (scenario: vote service needs configmap access only)
- Secret base64 is not encryption (true/false)
- Secret volume mount vs env var visibility
- Defense-in-depth layering (which layer protects against what)
- RBAC additive nature (can't remove permissions from other bindings)
- Voting App security scenario (scenario: which NetworkPolicy allows vote->redis?)

Module metadata: Module: 5, Topic: Security (NetworkPolicy, PSA, RBAC), Question Count: 14
  </action>
  <verify>
    - `docs/section-5/03-lab.md` exists with all 8 sections
    - Lab has 4 main tasks + 1 challenge task
    - Lab setup creates KIND cluster with Calico CNI (disableDefaultCNI: true)
    - Lab Task 1 includes DNS allow rule (critical gotcha)
    - Lab includes NetworkPolicy verification showing blocked traffic
    - `docs/section-5/quiz.md` has at least 14 questions
    - Quiz includes scenario about DNS allowlist requirement
    - `npm run build` succeeds
    - No emojis, all code blocks have language tags
  </verify>
  <done>Module 5 lab walks learners through securing the Voting App: Calico CNI setup, default-deny NetworkPolicy with selective allow, PSA enforcement, RBAC least-privilege, and Secrets management. Quiz has 14 questions testing security concepts.</done>
</task>

</tasks>

<verification>
- Module 5 has 4 content files: 01-overview.mdx (updated), 02-reading.md, 03-lab.md, quiz.md
- Reading is 15-20 min with 3-4 Mermaid diagrams
- Lab follows 8-section template with 4 tasks + 1 challenge
- Lab creates new KIND cluster with Calico CNI (mandatory for NetworkPolicy)
- Lab includes critical DNS allowlist step
- Lab demonstrates defense-in-depth (NetworkPolicy + PSA + RBAC + Secrets)
- Quiz has 14 questions in correct format
- `npm run build` succeeds
</verification>

<success_criteria>
Module 5 is complete: security concepts explained with diagrams (15-20 min read), hands-on lab securing the Voting App layer by layer (50-60 min), and quiz testing security knowledge (14 questions). The Voting App is secured with NetworkPolicy, PSA, RBAC, and Secrets.
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-content/04-01-SUMMARY.md`
</output>
